<meta charset="utf-8">
<title>Visualize Computation - Inside Out</title>

<script src="http://d3js.org/d3.v3.js"></script>
<script src="http://cpettitt.github.io/project/graphlib-dot/v0.5.2/graphlib-dot.js"></script>
<script src="http://cpettitt.github.io/project/dagre-d3/latest/dagre-d3.js"></script>

<style>
  svg {
  border: 1px solid #999;
  overflow: hidden;
  }

  .node {
  white-space: nowrap;
  }

  .node rect,
  .node circle,
  .node ellipse {
  stroke: #333;
  fill: #7f7;
  stroke-width: 1.5px;
  }

  .node h2 {
    color: red;
    font-size: 22pt;
    text-align: center;
  }

  .node h3 {
    color: blue;
    font-size: 14pt;
    text-align: center;
  }

  .cluster rect {
  stroke: #333;
  fill: #000;
  fill-opacity: 0.1;
  stroke-width: 1.5px;
  }

  .edgePath path.path {
  stroke: #333;
  stroke-width: 1.5px;
  fill: none;
  }
</style>

<style>
  h1, h2 {
  color: #333;
  }

  textarea {
  width: 1200px;
  }

  label {
  margin-top: 1em;
  display: block;
  }

  .error {
  color: red;
  }
</style>

<body onLoad="tryDraw();">

  <h1>Visualize Computation - Inside Out</h1>

  <h2>Input</h2>

  <form>
    <label for="inputGraph">Dependency Graph of computation in JSON</label>
    <textarea id="inputGraph" rows="5" style="display: block" onKeyUp="tryDraw();">
      {"vertices":[{"name":"Initial Input","result":"Input with 105 paths"},{"name":"Evaluation Interval","result":"2015-07-20 to 2015-08-20"},{"name":"Paths Filtering","result":"Input with 105 paths"},{"name":"Unnamed Stage","result":"Input with 104 paths"},{"name":"Inception Date","result":"2004-06-30"},{"name":"Unnamed Stage","result":"Input with 104 paths"},{"name":"Unnamed Stage","result":"ABSENT"},{"name":"Input Preprocessing","result":"Input with 105 paths"},{"name":"Evaluation Interval","result":"2015-07-20 to 2015-08-20"},{"name":"Input Preprocessing","result":"Input with 105 paths"},{"name":"Internal Calculation","result":"-1.46 %"},{"name":"TWR","result":"-1.46 %"},{"name":"Evaluation Interval","result":"2015-07-20 to 2015-08-20"},{"name":"Input Preprocessing","result":"Input with 105 paths"},{"name":"Evaluation Interval","result":"2015-07-20 to 2015-08-20"},{"name":"Input Preprocessing","result":"Input with 105 paths"},{"name":"Unnamed Stage","result":"Input with 104 paths"},{"name":"Inception Date","result":"2004-06-30"},{"name":"Inception Event Date","result":"2004-07-01"},{"name":"Composite Intervals","result":"[2015-07-20 to 2015-07-31, 2015-07-31 to 2015-08-20]"},{"name":"Composite Benchmark","result":"-0.61 %"},{"name":"Benchmark Return","result":"-0.61 %"},{"name":"Annualization of Benchmark Return","result":"-0.61 %"},{"name":"Benchmark Return","result":"-0.61 %"},{"name":"Active Return","result":"-0.85 %"}],"edges":[[1,0],[2,0],[2,1],[3,2],[4,3],[5,2],[6,5],[7,2],[7,4],[7,6],[8,7],[9,7],[9,8],[10,9],[11,9],[11,10],[12,7],[13,7],[13,12],[14,13],[15,13],[15,14],[16,15],[17,16],[18,17],[19,15],[19,18],[20,19],[20,15],[21,20],[22,15],[22,21],[23,22],[24,11],[24,23]]}
    </textarea>
  </form>

  <h2>Graph Visualization</h2>

  <svg width="1200" height=600>
    <g/>
  </svg>

  <script>
    // Create a new directed graph
var g = new dagreD3.graphlib.Graph().setGraph({});

var inputGraphRaw = document.querySelector("#inputGraph").value;
var inputGraph = JSON.parse(inputGraphRaw);

var vertexId = 0;
inputGraph.vertices.forEach(function(vertex) { 
  label = "<h2>" + vertex.name + "</h2>";
  result = vertex.result
  if (result.length > 50) {
    result = result.substr(0, 50) + "...";
  }
  label += "<h3>" + result + "</h3>";

  g.setNode(vertexId, 
      {
        labelType: "html",
        label: label,
        rx: 5,
        ry: 5,
        padding: 10,
        class: "node"
      }
    );  
  vertexId+=1;
});
inputGraph.edges.forEach(function(edge) {g.setEdge(edge[1], edge[0], {label : ""});});
var svg = d3.select("svg"),
    inner = svg.select("g");

// Set up zoom support
var zoom = d3.behavior.zoom().on("zoom", function() {
      inner.attr("transform", "translate(" + d3.event.translate + ")" +
                                  "scale(" + d3.event.scale + ")");
    });
svg.call(zoom);

// Create the renderer
var render = new dagreD3.render();

// Run the renderer. This is what draws the final graph.
render(inner, g);

// Center the graph
var initialScale = 0.75;
zoom
  .translate([(svg.attr("width") - g.graph().width * initialScale) / 2, 20])
  .scale(initialScale)
  .event(svg);
svg.attr('height', g.graph().height * initialScale + 40);
  </script>
  
